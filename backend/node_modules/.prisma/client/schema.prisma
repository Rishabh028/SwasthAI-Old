// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== USER MODELS ====================

model User {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  email           String    @unique
  phone           String?   @unique
  passwordHash    String?
  fullName        String?
  profilePhotoUrl String?
  dateOfBirth     DateTime?
  gender          String? // male, female, other
  bloodGroup      String? // A+, B+, O+, etc
  city            String?
  state           String?
  country         String?
  address         String?
  abhaId          String?   @unique
  isVerified      Boolean   @default(false)
  isActive        Boolean   @default(true)
  role            String    @default("user") // user, doctor, pharmacy, lab, admin
  lastLogin       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  healthProfile        HealthProfile?
  doctorProfile        Doctor?
  appointments         Appointment[]
  appointmentsAsDoctor Appointment[]         @relation("DoctorAppointments")
  medicineOrders       MedicineOrder[]
  labBookings          LabBooking[]
  healthRecords        HealthRecord[]
  forumPosts           ForumPost[]
  forumComments        ForumComment[]
  postUpvotes          PostUpvote[]
  commentUpvotes       CommentUpvote[]
  articles             HealthArticle[]
  savedArticles        SavedArticle[]
  notifications        Notification[]
  reviews              DoctorReview[]
  symptomSessions      SymptomCheckSession[]
  coachSessions        CoachSession[]

  @@index([email])
  @@index([phone])
  @@index([role])
}

model HealthProfile {
  id                     Int      @id @default(autoincrement())
  userId                 Int      @unique
  heightCm               Float?
  weightKg               Float?
  bmi                    Float?
  bloodPressureSystolic  Int?
  bloodPressureDiastolic Int?
  heartRate              Int?
  conditions             String?  @default("[]") // JSON array of conditions
  allergies              String?  @default("[]")
  medications            String?  @default("[]")
  vaccinationRecords     String?  @default("[]")
  healthScore            Int      @default(50)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ==================== DOCTOR MODELS ====================

model Doctor {
  id                    Int      @id @default(autoincrement())
  uuid                  String   @unique @default(uuid())
  userId                Int      @unique
  specialty             String
  qualifications        String?
  experienceYears       Int?
  licenseNumber         String?  @unique
  clinicName            String?
  clinicAddress         String?
  latitude              Float?
  longitude             Float?
  consultationFee       Float    @default(500)
  averageRating         Float    @default(0)
  totalRatings          Int      @default(0)
  availability          String? // JSON availability schedule
  isVerified            Boolean  @default(false)
  verificationDocuments String? // JSON array of doc URLs
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments Appointment[]
  reviews      DoctorReview[]

  @@index([userId])
  @@index([specialty])
}

model DoctorReview {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  doctorId      Int
  userId        Int
  appointmentId Int?
  rating        Int // 1-5
  review        String?
  verified      Boolean  @default(true)
  helpfulCount  Int      @default(0)
  createdAt     DateTime @default(now())

  doctor      Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointment Appointment? @relation(fields: [appointmentId], references: [id])

  @@index([doctorId])
  @@index([userId])
}

// ==================== APPOINTMENT MODELS ====================

model Appointment {
  id               Int      @id @default(autoincrement())
  uuid             String   @unique @default(uuid())
  userId           Int
  doctorId         Int
  appointmentDate  DateTime
  consultationType String // "online" or "offline"
  status           String   @default("scheduled") // scheduled, completed, cancelled, rescheduled
  reason           String?
  notes            String?
  meetingLink      String?
  recordingUrl     String?
  prescriptionId   Int?
  paymentId        String?
  paymentStatus    String   @default("pending") // pending, completed, failed
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  doctor        User           @relation("DoctorAppointments", fields: [doctorId], references: [id], onDelete: Cascade, map: "Appointment_doctor_fkey")
  doctorProfile Doctor         @relation(fields: [doctorId], references: [userId], map: "Appointment_doctorProfile_fkey")
  prescription  Prescription?  @relation(fields: [prescriptionId], references: [id])
  callSession   CallSession?
  reviews       DoctorReview[]

  @@index([userId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
}

model Prescription {
  id            Int      @id @default(autoincrement())
  uuid          String   @unique @default(uuid())
  appointmentId Int?
  doctorId      Int
  userId        Int
  medicines     String // JSON array of {medicineId, qty, dosage, frequency}
  instructions  String?
  validityDays  Int      @default(30)
  issuedAt      DateTime @default(now())
  createdAt     DateTime @default(now())

  appointments Appointment[]

  @@index([doctorId])
  @@index([userId])
}

model CallSession {
  id            Int       @id @default(autoincrement())
  uuid          String    @unique @default(uuid())
  appointmentId Int       @unique
  roomId        String?
  provider      String? // "jitsi", "twilio", "webrtc"
  token         String?
  startedAt     DateTime?
  endedAt       DateTime?
  recordingUrl  String?
  createdAt     DateTime  @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  @@index([appointmentId])
}

// ==================== MEDICINE & PHARMACY MODELS ====================

model Medicine {
  id                   Int      @id @default(autoincrement())
  uuid                 String   @unique @default(uuid())
  name                 String
  composition          String?
  category             String?
  price                Float
  manufacturer         String?
  stockQty             Int      @default(0)
  description          String?
  sideEffects          String?
  interactions         String?
  requiresPrescription Boolean  @default(false)
  available            Boolean  @default(true)
  createdAt            DateTime @default(now())

  orderItems MedicineOrderItem[]

  @@index([name])
  @@index([category])
}

model MedicineOrder {
  id                   Int       @id @default(autoincrement())
  uuid                 String    @unique @default(uuid())
  userId               Int
  orderDate            DateTime  @default(now())
  deliveryAddress      String
  status               String    @default("pending") // pending, confirmed, dispatched, delivered, cancelled
  totalAmount          Float
  paymentMethod        String? // "card", "upi", "wallet"
  paymentStatus        String    @default("pending")
  prescriptionUrl      String?
  deliveryDate         DateTime?
  expectedDeliveryDate DateTime?
  trackingNumber       String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  user  User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items MedicineOrderItem[]

  @@index([userId])
  @@index([status])
}

model MedicineOrderItem {
  id         Int   @id @default(autoincrement())
  orderId    Int
  medicineId Int
  quantity   Int
  price      Float

  order    MedicineOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  medicine Medicine      @relation(fields: [medicineId], references: [id])

  @@unique([orderId, medicineId])
}

// ==================== LAB MODELS ====================

model LabTest {
  id             Int      @id @default(autoincrement())
  uuid           String   @unique @default(uuid())
  name           String
  category       String?
  price          Float
  description    String?
  preparation    String?
  parameters     String? // JSON array
  turnaroundTime String?
  available      Boolean  @default(true)
  createdAt      DateTime @default(now())

  bookings LabBookingTest[] @relation("LabTestBookings")

  @@index([name])
  @@index([category])
}

model LabBooking {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  userId          Int
  bookingDate     DateTime
  collectionType  String // "home" or "lab"
  address         String?
  status          String    @default("booked") // booked, sample_collected, processing, report_ready, cancelled
  totalAmount     Float
  paymentStatus   String    @default("pending")
  reportUrl       String?
  reportReadyDate DateTime?
  createdAt       DateTime  @default(now())

  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  tests  LabBookingTest[]
  report LabReport?

  @@index([userId])
  @@index([status])
}

model LabBookingTest {
  id        Int @id @default(autoincrement())
  bookingId Int
  testId    Int

  booking LabBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  test    LabTest    @relation("LabTestBookings", fields: [testId], references: [id])

  @@unique([bookingId, testId])
}

model LabReport {
  id              Int       @id @default(autoincrement())
  uuid            String    @unique @default(uuid())
  bookingId       Int       @unique
  reportUrl       String
  results         String? // JSON results
  status          String    @default("pending") // pending, ready, reviewed
  reviewedById    Int?
  interpretation  String?
  recommendations String?
  readyAt         DateTime?
  createdAt       DateTime  @default(now())

  booking LabBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)

  @@index([bookingId])
}

// ==================== HEALTH RECORDS ====================

model HealthRecord {
  id            Int       @id @default(autoincrement())
  uuid          String    @unique @default(uuid())
  userId        Int
  recordType    String // "prescription", "lab_report", "doctor_note", "image", "other"
  title         String
  description   String?
  fileUrl       String
  fileName      String
  fileType      String? // pdf, jpg, png, etc
  fileSize      Int?
  doctorId      Int?
  appointmentId Int?
  documentDate  DateTime?
  isPublic      Boolean   @default(false)
  sharedWith    String?   @default("[]") // JSON array of user IDs
  createdAt     DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recordType])
}

// ==================== FORUM MODELS ====================

model ForumPost {
  id             Int      @id @default(autoincrement())
  uuid           String   @unique @default(uuid())
  userId         Int
  title          String
  content        String
  category       String // general, nutrition, fitness, mental-health, etc
  status         String   @default("active") // active, hidden, deleted
  upvotes        Int      @default(0)
  downvotes      Int      @default(0)
  views          Int      @default(0)
  commentsCount  Int      @default(0)
  pinned         Boolean  @default(false)
  verifiedDoctor Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments      ForumComment[]
  upvotesByUser PostUpvote[]

  @@index([userId])
  @@index([category])
  @@index([createdAt])
}

model ForumComment {
  id              Int      @id @default(autoincrement())
  uuid            String   @unique @default(uuid())
  postId          Int
  userId          Int
  parentCommentId Int?
  content         String
  upvotes         Int      @default(0)
  helpfulCount    Int      @default(0)
  verifiedDoctor  Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  post          ForumPost       @relation(fields: [postId], references: [id], onDelete: Cascade)
  user          User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  parentComment ForumComment?   @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies       ForumComment[]  @relation("CommentReplies")
  upvotesByUser CommentUpvote[]

  @@index([postId])
  @@index([userId])
}

model PostUpvote {
  id       Int    @id @default(autoincrement())
  postId   Int
  userId   Int
  voteType String // "upvote", "downvote"

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
}

model CommentUpvote {
  id        Int    @id @default(autoincrement())
  commentId Int
  userId    Int
  voteType  String // "upvote", "downvote"

  comment ForumComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([commentId, userId])
}

// ==================== ARTICLES ====================

model HealthArticle {
  id               Int       @id @default(autoincrement())
  uuid             String    @unique @default(uuid())
  title            String
  slug             String    @unique
  content          String
  category         String // nutrition, fitness, mental-health, etc
  authorId         Int?
  featuredImageUrl String?
  status           String    @default("draft") // draft, published, archived
  views            Int       @default(0)
  publishedAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  author   User?            @relation(fields: [authorId], references: [id])
  comments ArticleComment[]
  savedBy  SavedArticle[]

  @@index([slug])
  @@index([category])
}

model ArticleComment {
  id        Int      @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  articleId Int
  userId    Int
  content   String
  upvotes   Int      @default(0)
  createdAt DateTime @default(now())

  article HealthArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@index([articleId])
}

model SavedArticle {
  id        Int      @id @default(autoincrement())
  userId    Int
  articleId Int
  savedAt   DateTime @default(now())

  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  article HealthArticle @relation(fields: [articleId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
}

// ==================== NOTIFICATIONS ====================

model Notification {
  id        Int      @id @default(autoincrement())
  uuid      String   @unique @default(uuid())
  userId    Int
  type      String // appointment, order, lab, forum, etc
  title     String
  message   String
  data      String? // JSON meta data
  read      Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
}

// ==================== AI/LLM MODELS ====================

model SymptomCheckSession {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique @default(uuid())
  userId       Int
  conversation String // JSON array of messages
  result       String? // JSON result
  riskLevel    String? // mild, moderate, severe
  createdAt    DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model CoachSession {
  id           Int      @id @default(autoincrement())
  uuid         String   @unique @default(uuid())
  userId       Int
  conversation String // JSON array of messages
  savedPlan    String? // JSON saved wellness plan
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}
